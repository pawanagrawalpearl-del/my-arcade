<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buddy Fling - Touch Edition</title>
    <style>
        body {
            background: #020617;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: #38bdf8;
            font-weight: bold;
            z-index: 10;
        }
        
        canvas {
            background: radial-gradient(circle, #1e293b 0%, #020617 100%);
            border: 2px solid #334155;
            max-width: 95vw;
            max-height: 80vh;
        }
        
        .ui {
            position: absolute;
            top: 20px;
            text-align: center;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <a href="index.html" class="back-link">‚Üê BACK TO ARCADE</a>

    <div class="ui">
        <div style="color: #38bdf8; font-size: 1.5rem; font-weight: bold;">BUDDY FLING</div>
        <div style="color: #64748b;">Grab and toss the buddy into orbit!</div>
    </div>

    <canvas id="flingCanvas" width="800" height="600"></canvas>

    <script>
        const canvas = document.getElementById("flingCanvas");
        const ctx = canvas.getContext("2d");

        let points = [];
        let sticks = [];
        let grabbedPoint = null;
        let mouse = {
            x: 0,
            y: 0,
            down: false
        };

        function initRagdoll() {
            // Create points (head, torso, limbs)
            points.push({
                x: 400,
                y: 200,
                oldX: 400,
                oldY: 200,
                r: 15,
                mass: 1
            }); // 0: Head
            points.push({
                x: 400,
                y: 250,
                oldX: 400,
                oldY: 250,
                r: 20,
                mass: 1
            }); // 1: Torso
            points.push({
                x: 350,
                y: 250,
                oldX: 350,
                oldY: 250,
                r: 10,
                mass: 1
            }); // 2: L-Hand
            points.push({
                x: 450,
                y: 250,
                oldX: 450,
                oldY: 250,
                r: 10,
                mass: 1
            }); // 3: R-Hand
            points.push({
                x: 380,
                y: 320,
                oldX: 380,
                oldY: 320,
                r: 12,
                mass: 1
            }); // 4: L-Foot
            points.push({
                x: 420,
                y: 320,
                oldX: 420,
                oldY: 320,
                r: 12,
                mass: 1
            }); // 5: R-Foot

            const connect = (p1, p2, dist) => sticks.push({
                p1: points[p1],
                p2: points[p2],
                length: dist
            });
            connect(0, 1, 50); // Neck
            connect(1, 2, 50); // L-Arm
            connect(1, 3, 50); // R-Arm
            connect(1, 4, 70); // L-Leg
            connect(1, 5, 70); // R-Leg
        }

        // --- UNIVERSAL INPUT ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        const onDown = (e) => {
            const pos = getPos(e);
            mouse.x = pos.x;
            mouse.y = pos.y;
            mouse.down = true;
            points.forEach(p => {
                const d = Math.sqrt((pos.x - p.x) ** 2 + (pos.y - p.y) ** 2);
                if (d < 30) grabbedPoint = p;
            });
        };

        const onMove = (e) => {
            if (e.touches) e.preventDefault();
            const pos = getPos(e);
            mouse.x = pos.x;
            mouse.y = pos.y;
        };

        const onUp = () => {
            mouse.down = false;
            grabbedPoint = null;
        };

        canvas.addEventListener('mousedown', onDown);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);

        canvas.addEventListener('touchstart', onDown, {
            passive: false
        });
        canvas.addEventListener('touchmove', onMove, {
            passive: false
        });
        window.addEventListener('touchend', onUp);

        function update() {
            const gravity = 0.3;
            const friction = 0.99;

            points.forEach(p => {
                if (p === grabbedPoint) {
                    p.x = mouse.x;
                    p.y = mouse.y;
                    p.oldX = mouse.x;
                    p.oldY = mouse.y;
                } else {
                    let vx = (p.x - p.oldX) * friction;
                    let vy = (p.y - p.oldY) * friction;
                    p.oldX = p.x;
                    p.oldY = p.y;
                    p.x += vx;
                    p.y += vy + gravity;
                }

                // Wall bounce
                if (p.x > 800) p.x = 800;
                if (p.x < 0) p.x = 0;
                if (p.y > 600) p.y = 600;
                if (p.y < 0) p.y = 0;
            });

            for (let i = 0; i < 5; i++) {
                sticks.forEach(s => {
                    const dx = s.p2.x - s.p1.x;
                    const dy = s.p2.y - s.p1.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const diff = s.length - dist;
                    const offX = (dx / dist) * diff * 0.5;
                    const offY = (dy / dist) * diff * 0.5;
                    if (s.p1 !== grabbedPoint) {
                        s.p1.x -= offX;
                        s.p1.y -= offY;
                    }
                    if (s.p2 !== grabbedPoint) {
                        s.p2.x += offX;
                        s.p2.y += offY;
                    }
                });
            }
        }

        function draw() {
            ctx.clearRect(0, 0, 800, 600);

            ctx.strokeStyle = "#38bdf8";
            ctx.lineWidth = 4;
            sticks.forEach(s => {
                ctx.beginPath();
                ctx.moveTo(s.p1.x, s.p1.y);
                ctx.lineTo(s.p2.x, s.p2.y);
                ctx.stroke();
            });

            points.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = (p === grabbedPoint) ? "#f472b6" : "#38bdf8";
                ctx.fill();
            });

            requestAnimationFrame(() => {
                update();
                draw();
            });
        }

        initRagdoll();
        draw();
    </script>
</body>

</html>
