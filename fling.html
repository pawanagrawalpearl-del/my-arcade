<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buddy True Fling - Arcade</title>
    <style>
        body {
            background: #020617;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            text-decoration: none;
            color: #38bdf8;
            font-weight: bold;
            transition: 0.3s;
            z-index: 10;
        }
        
        .back-link:hover {
            color: white;
            transform: translateX(-5px);
        }
        
        canvas {
            background: linear-gradient(#38bdf8, #020617);
            border: 2px solid #334155;
            border-radius: 15px;
            cursor: grab;
        }
        
        .stats {
            position: absolute;
            top: 20px;
            text-align: center;
            pointer-events: none;
        }
        
        #altitude {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fbbf24;
        }
        
        .indicator {
            position: absolute;
            bottom: 100px;
            color: #38bdf8;
            font-weight: bold;
            display: none;
        }
    </style>
</head>

<body>

    <a href="index.html" class="back-link">← BACK TO ARCADE</a>

    <div class="stats">
        <div id="altitude">0 m</div>
        <div id="location" style="color: #fff; text-transform: uppercase; letter-spacing: 1px;">Ground Level</div>
    </div>

    <div id="fallingAlert" class="indicator">⚠️ HE'S FALLING BACK DOWN! ⚠️</div>

    <canvas id="ragdollCanvas" width="450" height="650"></canvas>
    <p style="color: #94a3b8; margin-top: 15px;">Flick Buddy upwards to launch him!</p>

    <script>
        const canvas = document.getElementById("ragdollCanvas");
        const ctx = canvas.getContext("2d");
        const altDisplay = document.getElementById("altitude");
        const locDisplay = document.getElementById("location");
        const alertBox = document.getElementById("fallingAlert");

        let isDragging = false;
        let lastMouse = {
            x: 0,
            y: 0
        };
        let mouseVel = {
            x: 0,
            y: 0
        };

        const buddy = {
            torso: {
                x: 225,
                y: 550,
                vx: 0,
                vy: 0,
                r: 28
            },
            head: {
                x: 225,
                y: 505,
                r: 20
            },
            lArm: {
                x: 185,
                y: 535,
                r: 12
            },
            rArm: {
                x: 265,
                y: 535,
                r: 12
            },
            lLeg: {
                x: 200,
                y: 600,
                r: 14
            },
            rLeg: {
                x: 250,
                y: 600,
                r: 14
            }
        };

        function solveDistance(p1, p2, dist) {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            const angle = Math.atan2(dy, dx);
            p1.x = p2.x + Math.cos(angle) * dist;
            p1.y = p2.y + Math.sin(angle) * dist;
        }

        canvas.addEventListener("mousedown", (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;
            const d = Math.sqrt((mx - buddy.torso.x) ** 2 + (my - buddy.torso.y) ** 2);

            if (d < 60) {
                isDragging = true;
                buddy.torso.vx = 0;
                buddy.torso.vy = 0;
                canvas.style.cursor = "grabbing";
            }
        });

        window.addEventListener("mousemove", (e) => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            mouseVel.x = mx - lastMouse.x;
            mouseVel.y = my - lastMouse.y;

            if (isDragging) {
                buddy.torso.x = mx;
                buddy.torso.y = my;
            }
            lastMouse = {
                x: mx,
                y: my
            };
        });

        window.addEventListener("mouseup", () => {
            if (!isDragging) return;
            isDragging = false;
            canvas.style.cursor = "grab";

            // Direct fling speed
            buddy.torso.vx = mouseVel.x * 0.9;
            buddy.torso.vy = mouseVel.y * 0.9;
        });

        function update() {
            if (!isDragging) {
                // Apply Physics
                buddy.torso.vy += 0.25; // Gravity
                buddy.torso.x += buddy.torso.vx;
                buddy.torso.y += buddy.torso.vy;

                // Ground Collision
                if (buddy.torso.y > canvas.height - 50) {
                    buddy.torso.y = canvas.height - 50;
                    buddy.torso.vy *= -0.5; // Bounce
                    buddy.torso.vx *= 0.8; // Friction
                }

                // Wall Collision
                if (buddy.torso.x < 40 || buddy.torso.x > canvas.width - 40) {
                    buddy.torso.vx *= -0.7;
                }
            }

            // Ragdoll constraints
            const t = buddy.torso;
            solveDistance(buddy.head, t, 45);
            solveDistance(buddy.lArm, t, 50);
            solveDistance(buddy.rArm, t, 50);
            solveDistance(buddy.lLeg, t, 55);
            solveDistance(buddy.rLeg, t, 55);

            // Update Altitude UI based on how far above the floor he is
            let currentAlt = Math.max(0, Math.floor((550 - buddy.torso.y) / 2));
            altDisplay.innerText = currentAlt + " m";

            // Show alert when he is falling from a high height
            if (buddy.torso.y < -100 && buddy.torso.vy > 0) {
                alertBox.style.display = "block";
            } else {
                alertBox.style.display = "none";
            }
        }

        function drawPart(part, color, isHead = false) {
            ctx.beginPath();
            ctx.arc(part.x, part.y, part.r, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();
            if (isHead) {
                ctx.fillStyle = "black";
                ctx.beginPath();
                ctx.arc(part.x - 6, part.y - 2, 2, 0, Math.PI * 2);
                ctx.arc(part.x + 6, part.y - 2, 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Connectors
            ctx.beginPath();
            ctx.strokeStyle = "#555";
            ctx.lineWidth = 10;
            ctx.lineCap = "round";
            [buddy.head, buddy.lArm, buddy.rArm, buddy.lLeg, buddy.rLeg].forEach(p => {
                ctx.moveTo(buddy.torso.x, buddy.torso.y);
                ctx.lineTo(p.x, p.y);
            });
            ctx.stroke();

            drawPart(buddy.torso, "#f472b6");
            drawPart(buddy.head, "#fdba74", true);
            drawPart(buddy.lArm, "#f472b6");
            drawPart(buddy.rArm, "#f472b6");
            drawPart(buddy.lLeg, "#f472b6");
            drawPart(buddy.rLeg, "#f472b6");
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>

</html>